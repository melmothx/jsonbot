#!/usr/bin/env python
#
#

## bootstrap

import warnings
warnings.simplefilter("ignore")

import os, sys
sys.path.insert(0, os.getcwd())

from gozerlib.version import getversion
print getversion('SXMPP')

## gozerlib impors

from gozerlib.socklib.xmpp.bot import SXMPPBot
from gozerlib.boot import plugin_packages, boot
from gozerlib.utils.log import setloglevel
from gozerlib.config import Config
from gozerlib.errors import NoOwnerSet
from gozerlib.fleet import fleet
from gozerlib.utils.mainloop import mainloop
from gozerlib.utils.opts import makeopts, makeconfig
import gozerlib.users as users
import gozerlib

## basic imports

import logging
import time
import os

## options parser

opts = makeopts()
boot(opts.datadir)

cfg = makeconfig('sxmpp', opts)
if opts.nick: cfg.nick = opts.nick
cfg.save()

## runtime

setloglevel(cfg.loglevel)

#from gozerlib.plugins import plugs
#plugs.loadall()

## start bot
try:
    bot = SXMPPBot(cfg)
    bot.nick = cfg.nick or 'jsonbot'
except NoOwnerSet, ex:
    print "owner is not set in %s - use the -o option" % str(ex)
    os._exit(1)

if opts.channel and not opts.channel in bot.state['joinedchannels']:
    bot.state['joinedchannels'].append(opts.channel)
    bot.state.save()
    
if opts.all:
    print "available fleet bots: %s" % fleet.avail()

fleet.addbot(bot)
bot.start()
mainloop()
