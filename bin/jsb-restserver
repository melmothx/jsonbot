#!/usr/bin/env python
#
#

## boot

import os, sys
sys.path.insert(0, os.getcwd())

## gozerlib imports

from gozerlib.utils.generic import getversion
from gozerlib.utils.url import posturl, getpostdata
from gozerlib.socket.rest.server import RestServer, RestRequestHandler
from gozerlib.eventbase import EventBase
from gozerlib.utils.exception import handle_exception
from gozerlib.examples import examples
from gozerlib.config import Config
from gozerlib.persist import Persist

## simplejson imports

from simplejson import dumps

## basic imports

import socket
import re
import logging

## options parsing

from optparse import OptionParser 

parser = OptionParser(usage='usage: %prog [options]', version='%prog ' + getversion())
parser.add_option('-s', '--server', type='string',
                  default=socket.gethostbyname(socket.getfqdn()),
                  dest='server',
                  help="host to run the bot on")
parser.add_option('-p', '--port', type='string', default='11111',
                  dest='port',   
                  help="port of the server")
parser.add_option('-l', '--loglevel', type='string', default='error',
                  dest='loglevel',   
                  help="loglevel of the server")

opts, args = parser.parse_args()
opts.args = args

## defines

cfg = Config("restserver")
if not cfg.disable:
    cfg.disable = []

if opts.server:
    cfg.host = opts.server

if opts.port:
    cfg.port = int(opts.port)

hp = "%s:%s" % (cfg.get('host'), cfg.get('port'))
url = "http://%s" % hp
server = None

## functions

def startserver(force=False):
    global server 
    if server and not force:
        logging.info("REST server is already running. ")
        return server

    try:
        server = RestServer((cfg.get('host'), cfg.get('port')), RestRequestHandler)

        if server:
            server.start()
            logging.warn('restserver - running at %s:%s' % (cfg.get('host'), cfg.get('port')))

            for mount in cfg.get('disable'):
                server.disable(mount)
        else:
            logging.error('restserver - failed to start server at %s:%s' % (cfg.get('host'), cfg.get('port')))

    except socket.error, ex:
        logging.warn('restserver - start - socket error: %s' % str(ex))

    except Exception, ex:
        handle_exception()

    return server

def stopserver():

    try:
        if not server:
            logging.warn('restserver - server is already stopped')
            return

        server.shutdown()

    except Exception, ex:
        handle_exception()
        pass

## JSONDATA

def json_GET(server, request):
    try:
        path = request.path.split("jsondata")[1]
    except (ValueError, IndexError):
        return dumps("can't find datapointer in path %s" % request.path)

    logging.warn("json.server - got path %s" % path)
    if len(path) > 2:
        path = 'gozerdata' + os.sep + path[1:]
        if '..' in path:
            return request.send_error(404)
        if not os.path.exists(path):
            logging.error("json.server - non existing file - %s" % path)
            request.send_error(404)
            return

        try:
            logging.warn("json.server - attempting to construct %s" % path)
            try:
                result = Persist(path)
                if result.data and result.data.public:
                    try:
                        return dumps(result.data)
                    except TypeError:
                        result = Config(path)
                        logging.warn("json.server - got config - %s" % str(result))
                        if result and result.public:
                            try:
                                return dumps(result.data)
                            except TypeError:
                                request.send_error(404)
            except IOError:
                handle_exception()
                request.send_error(404)
                return
            request.send_error(404)
        except Exception, ex:
            handle_exception()
            request.send_error(500)
            return
    else:
        request.send_error(404)
        return

startserver()

if not server:
    print "can't start server"
else:
    server.addhandler('/jsondata/', 'GET', json_GET)
    server.addhandler('/favicon.ico', 'GET', json_GET)
    server.enable('/jsondata/') 
    server.serve()
