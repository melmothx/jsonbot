#!/usr/bin/env python
#
#

""" install the GAE upload dir so it can be uploaded. """

## gozerlib imports

from gozerlib.utils.generic import gethighest, dosed

## imports

import sys
import os
import pkg_resources
import shutil

## boot

if len(sys.argv) > 1:
     if not os.path.isdir('releases'):
         os.mkdir('releases')
     release = 'releases' + os.sep + sys.argv[1]
     if not os.path.isdir(release):
         os.mkdir(release)
     targetin = sys.argv[1]
else:
     release = 'upload'
     targetin = 'upload'


if os.path.isdir(release + '.old'):
    backup = 'releases' + os.sep + gethighest('releases', targetin + '.old')
else:
    backup = release + '.old'

if os.path.isdir(release):
    print "MOVING %s TO %s" % (release, backup)
    os.rename(release, backup)

#sys.path.insert(0, os.getcwd())
pkg_resources.require("jsonbot>=0.1")

## define

orig = 'jsonbot'

## functions

def copyover(source, target):

    print "COPYING RESULTS TO %s" % target

    try:
        shutil.copytree(source, target)   
    except OSError, ex:
        print "can't copy %s to %s ==> %s" % (source, target, str(ex))

    if len(sys.argv) > 1:
        sed(source, target)
  
def sed(source, target):

    print "source: %s target: %s" % (source, target)

    for f in os.listdir(target):
        if f.startswith('.'):
            continue
        if f.endswith(".pyc"):
            continue
        if f.endswith("~"):
            continue
        if os.path.isdir(target + os.sep + f):
            sed(source + os.sep + f, target + os.sep + f)
            continue
        else:
            print "sedding %s (%s) - %s" % (f, orig, targetin)
            dosed(target + os.sep + f, 's/%s/%s/' % (orig, targetin))
            dosed(target + os.sep + f, 's/%s/%s/' % (orig.upper(), targetin.upper()))


## doit

source = pkg_resources.resource_filename("gaeupload", '')
copyover(source, release)
source = pkg_resources.resource_filename("tests", '')
copyover(source, release + os.sep + 'tests')
source = pkg_resources.resource_filename('config', '')
copyover(source, release + os.sep + 'config')
source = pkg_resources.resource_filename('gozerlib', '')
copyover(source, release + os.sep + 'gozerlib')
source = pkg_resources.resource_filename('commonplugs', '')
copyover(source, release + os.sep + 'commonplugs')
source = pkg_resources.resource_filename('waveplugs', '')
copyover(source, release + os.sep + 'waveplugs')
source = pkg_resources.resource_filename('simplejson', '')
copyover(source, release + os.sep + 'simplejson')

