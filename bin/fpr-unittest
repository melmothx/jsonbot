#!/usr/bin/env python
#
#

## boot
import sys
import os

#sys.path.insert(0, os.getcwd() + os.sep + 'tests')
sys.path.append(os.getcwd())

## lib imports

from gozerlib.utils.exception import handle_exception
from gozerlib.utils.log import setloglevel
setloglevel("error")
## basic imports

import unittest
import glob
import signal


## define

testname = None

try:
    testname = sys.argv[1]
except IndexError:
    pass

## functions

def stop(x, y):
    os._exit(0)

signal.signal(signal.SIGTERM, stop)

## main

try:
    if testname:
        name = 'tests.%s' % testname
        suite = unittest.defaultTestLoader.loadTestsFromName(name)
        unittest.TextTestRunner(verbosity=10).run(suite)
    else:
        names =  map(lambda a: a[:-3], glob.glob('tests/*.py'))
        if not names:
            print "ERROR: can't find tests dir" 
            os._exit(1)
        names.remove("tests/__init__")
        print "USING %s" % names
        n = []
        for name in names:
            name = name.replace('/', '.')
            n.append(name)
        suite = unittest.defaultTestLoader.loadTestsFromNames(n)
        #    suites.append(suite)
        unittest.TextTestRunner(verbosity=10).run(suite)

except KeyboardInterrupt:
    os._exit(0)
except Exception, ex:
    handle_exception()
os._exit(0)
